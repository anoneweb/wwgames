<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Werewolf Game - Login & Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f7f9;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      margin-bottom: 20px;
      color: #4b6cb7;
      text-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .btn-group {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
    }
    .btn-group button {
      flex: 1;
      padding: 12px 0;
      border: none;
      background: #4b6cb7;
      color: white;
      font-weight: 600;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 3px 8px rgba(75,108,183,0.3);
    }
    .btn-group button:hover {
      background: #3956a4;
    }
    .section {
      width: 100%;
      max-width: 480px;
      background: white;
      padding: 25px 30px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(75,108,183,0.15);
      display: none;
      flex-direction: column;
    }
    .visible {
      display: flex;
    }
    label {
      font-weight: 600;
      margin-top: 15px;
      margin-bottom: 6px;
      color: #4b6cb7;
    }
    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1.8px solid #c1c9dd;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.3s ease;
      resize: vertical;
    }
    input[type="text"]:focus,
    input[type="password"]:focus,
    textarea:focus {
      outline: none;
      border-color: #4b6cb7;
      box-shadow: 0 0 6px #4b6cb7aa;
    }
    button[type="button"] {
      margin-top: 25px;
      padding: 12px;
      font-size: 16px;
      font-weight: 700;
      color: white;
      background: #4b6cb7;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(75,108,183,0.4);
      transition: background-color 0.3s ease;
    }
    button[type="button"]:hover {
      background: #3956a4;
    }
    #role-display {
      margin-top: 18px;
      font-weight: 700;
      font-size: 18px;
      color: #2f4858;
      background: #d1e7ff;
      padding: 12px 18px;
      border-radius: 8px;
      box-shadow: inset 0 0 8px #a6c1ff;
    }
    #registerMsg,
    #loginMsg {
      margin-top: 14px;
      font-weight: 600;
      min-height: 20px;
      color: #d9534f; /* default red */
    }
    #registerMsg.success,
    #loginMsg.success {
      color: #28a745; /* green */
    }
    #adminTools {
      margin-top: 25px;
      width: 100%;
    }
    #playerList {
      margin-top: 15px;
      max-height: 220px;
      overflow-y: auto;
      padding-left: 20px;
      border: 1px solid #c1c9dd;
      border-radius: 8px;
      background: #f9fbff;
    }
    #playerList li {
      margin-bottom: 8px;
      font-weight: 600;
      color: #2f4858;
      list-style: none;
      padding-left: 20px;
      position: relative;
    }
    #playerList li::before {
      content: "üê∫";
      position: absolute;
      left: 0;
      top: 2px;
    }
    @media (max-width: 520px) {
      .btn-group {
        flex-direction: column;
      }
      .btn-group button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>Werewolf Game</h1>

  <div class="btn-group" role="group" aria-label="Navigation Buttons">
    <button type="button" onclick="showSection('register')">Daftar Pemain</button>
    <button type="button" onclick="showSection('login')">Login Pemain</button>
    <button type="button" onclick="showSection('admin')">Admin</button>
  </div>

  <!-- Daftar Pemain -->
  <section id="register-section" class="section" aria-labelledby="register-title" role="region">
    <h2 id="register-title">Daftar Pemain Baru</h2>
    <label for="regName">Nama Pemain</label>
    <input type="text" id="regName" name="regName" placeholder="Nama kamu" autocomplete="off" aria-required="true" />
    <label for="regPassword">Password</label>
    <input type="password" id="regPassword" name="regPassword" placeholder="Password" autocomplete="off" aria-required="true" />
    <button type="button" onclick="registerPlayer()">Daftar</button>
    <div id="registerMsg" role="alert" aria-live="polite"></div>
  </section>

  <!-- Login Pemain -->
  <section id="login-section" class="section" aria-labelledby="login-title" role="region">
    <h2 id="login-title">Login Pemain</h2>
    <label for="loginName">Nama Pemain</label>
    <input type="text" id="loginName" name="loginName" placeholder="Nama kamu" autocomplete="off" aria-required="true" />
    <label for="loginPassword">Password</label>
    <input type="password" id="loginPassword" name="loginPassword" placeholder="Password" autocomplete="off" aria-required="true" />
    <label for="loginGameCode">Kode Putaran</label>
    <input type="text" id="loginGameCode" name="loginGameCode" placeholder="Contoh: PUTARAN1" autocomplete="off" aria-required="true" />
    <button type="button" onclick="loginAndJoin()">Login & Gabung Game</button>
    <div id="loginMsg" role="alert" aria-live="polite"></div>
    <div id="role-display" aria-live="polite" tabindex="0"></div>
  </section>

  <!-- Admin -->
  <section id="admin-section" class="section" aria-labelledby="admin-title" role="region">
    <h2 id="admin-title">Admin</h2>
    <label for="adminPassword">Password Admin</label>
    <input type="password" id="adminPassword" name="adminPassword" placeholder="Password admin" autocomplete="off" aria-required="true" />
    <button type="button" onclick="checkAdmin()">Masuk</button>

    <div id="adminTools" style="display:none;">
      <h3>Buat Putaran Baru</h3>
      <label for="newGameCode">Kode Putaran</label>
      <input type="text" id="newGameCode" name="newGameCode" placeholder="Contoh: PUTARAN2" autocomplete="off" />
      <label for="rolesInput">Daftar Peran (1 per baris)</label>
      <textarea id="rolesInput" name="rolesInput" rows="5" placeholder="Werewolf\nSeer\nVillager\nVillager"></textarea>
      <button type="button" onclick="createGame()">Buat Game</button>

      <h3>Lihat Pemain</h3>
      <label for="viewGameCode">Kode Putaran</label>
      <input type="text" id="viewGameCode" name="viewGameCode" placeholder="Contoh: PUTARAN1" autocomplete="off" />
      <button type="button" onclick="loadPlayers()">Lihat Pemain</button>
      <ul id="playerList" aria-live="polite" tabindex="0"></ul>
    </div>
  </section>

  <script>
    // Firebase config, ganti dengan milik kamu
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD5rn8JWl9WjmKkEgnX7XzZwHGW3x2VQqQ",
  authDomain: "warewolf-game-ef2fd.firebaseapp.com",
  projectId: "warewolf-game-ef2fd",
  storageBucket: "warewolf-game-ef2fd.firebasestorage.app",
  messagingSenderId: "342790419722",
  appId: "1:342790419722:web:e51e9b9c1c54286729f6f3",
  measurementId: "G-6VE9WCE2E2"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function showSection(section) {
      ["register", "login", "admin"].forEach((s) => {
        document.getElementById(s + "-section").classList.remove("visible");
      });
      document.getElementById(section + "-section").classList.add("visible");
      clearMessages();
    }
    function clearMessages() {
      document.getElementById("registerMsg").textContent = "";
      document.getElementById("loginMsg").textContent = "";
      document.getElementById("role-display").textContent = "";
    }

    // Admin password sederhana
    const ADMIN_PASS = "werewolf123";
    function checkAdmin() {
      const pass = document.getElementById("adminPassword").value;
      if (pass === ADMIN_PASS) {
        document.getElementById("adminTools").style.display = "block";
      } else {
        alert("Password admin salah.");
      }
    }

    // Register pemain global
    async function registerPlayer() {
      const name = document.getElementById("regName").value.trim();
      const password = document.getElementById("regPassword").value;
      const msg = document.getElementById("registerMsg");
      msg.textContent = "";
      msg.classList.remove("success");
      if (!name || !password) {
        msg.textContent = "Nama dan password wajib diisi.";
        return;
      }
      try {
        const playerDoc = await db.collection("players_global").doc(name).get();
        if (playerDoc.exists) {
          msg.textContent = "Nama sudah terdaftar, silakan pilih nama lain.";
          return;
        }
        await db.collection("players_global").doc(name).set({ password });
        msg.textContent = "Pendaftaran berhasil! Silakan login.";
        msg.classList.add("success");
      } catch (err) {
        console.error(err);
        msg.textContent = "Terjadi kesalahan saat mendaftar.";
      }
    }

    // Login dan gabung putaran
    async function loginAndJoin() {
      const name = document.getElementById("loginName").value.trim();
      const password = document.getElementById("loginPassword").value;
      const gameCode = document.getElementById("loginGameCode").value.trim().toUpperCase();
      const msg = document.getElementById("loginMsg");
      const roleDisplay = document.getElementById("role-display");
      msg.textContent = "";
      roleDisplay.textContent = "";
      msg.classList.remove("success");

      if (!name || !password || !gameCode) {
        msg.textContent = "Semua kolom wajib diisi.";
        return;
      }

      try {
        // Cek data pemain global
        const playerDoc = await db.collection("players_global").doc(name).get();
        if (!playerDoc.exists) {
          msg.textContent = "Nama pemain tidak terdaftar, silakan daftar dulu.";
          return;
        }
        if (playerDoc.data().password !== password) {
          msg.textContent = "Password salah.";
          return;
        }

        // Cek game
        const gameRef = db.collection("games").doc(gameCode);
        const gameDoc = await gameRef.get();
        if (!gameDoc.exists) {
          msg.textContent = "Kode putaran tidak ditemukan.";
          return;
        }

        // Cek pemain di putaran ini
        const playerInGameRef = gameRef.collection("players").doc(name);
        const playerInGameDoc = await playerInGameRef.get();

        if (playerInGameDoc.exists) {
          // Sudah terdaftar di putaran, tampilkan peran
          roleDisplay.textContent = `Halo ${name}, peran kamu: ${playerInGameDoc.data().role}`;
          msg.classList.add("success");
          return;
        }

        // Kalau pemain baru di putaran, bagi peran acak dari sisa
        const allPlayersSnap = await gameRef.collection("players").get();
        const assignedRoles = allPlayersSnap.docs.map((doc) => doc.data().role);
        const allRoles = [...gameDoc.data().roles];
        let roleCount = {};
        allRoles.forEach((r) => (roleCount[r] = (roleCount[r] || 0) + 1));
        assignedRoles.forEach((r) => (roleCount[r]--));

        const availableRoles = Object.entries(roleCount)
          .filter(([_, c]) => c > 0)
          .map(([r]) => r);

        if (availableRoles.length === 0) {
          msg.textContent = "Peran habis, game penuh.";
          return;
        }

        const randomRole =
          availableRoles[Math.floor(Math.random() * availableRoles.length)];

        // Simpan peran pemain di putaran
        await playerInGameRef.set({ role: randomRole });

        roleDisplay.textContent = `Halo ${name}, peran kamu: ${randomRole}`;
        msg.classList.add("success");
      } catch (err) {
        console.error(err);
        msg.textContent = "Terjadi kesalahan.";
      }
    }

    // Buat game baru (admin)
    async function createGame() {
      const code = document.getElementById("newGameCode").value.trim().toUpperCase();
      const roles = document
        .getElementById("rolesInput")
        .value.trim()
        .split("\n")
        .map((r) => r.trim())
        .filter(Boolean);

      if (!code || roles.length === 0) {
        alert("Isi semua data.");
        return;
      }

      try {
        await db.collection("games").doc(code).set({ roles });
        alert("Game berhasil dibuat!");
      } catch (err) {
        console.error(err);
        alert("Gagal membuat game.");
      }
    }

    // Lihat pemain di putaran (admin)
    async function loadPlayers() {
      const code = document.getElementById("viewGameCode").value.trim().toUpperCase();
      const ul = document.getElementById("playerList");
      ul.innerHTML = "";

      if (!code) {
        alert("Masukkan kode putaran.");
        return;
      }

      try {
        const snapshot = await db
          .collection("games")
          .doc(code)
          .collection("players")
          .get();
        if (snapshot.empty) {
          ul.innerHTML = "<li>Belum ada pemain.</li>";
          return;
        }

        snapshot.forEach((doc) => {
          const li = document.createElement("li");
          li.textContent = `${doc.id}: ${doc.data().role}`;
          ul.appendChild(li);
        });
      } catch (err) {
        console.error(err);
        alert("Gagal memuat pemain.");
      }
    }

    // Show default section on load
    showSection('register');
  </script>
</body>
</html>
