 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Werewolf Game - Player</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 30px auto; }
    label, input, button { display: block; margin: 10px 0; }
    input, button { padding: 8px; font-size: 16px; }
    #role-display { margin-top: 20px; font-size: 1.2em; font-weight: bold; }
    #message { color: red; }
  </style>
</head>
<body>

  <h1>Werewolf Game - Player</h1>

  <label for="gameCode">Kode Akses Putaran:</label>
  <input type="text" id="gameCode" placeholder="Masukkan kode putaran" />

  <label for="playerName">Nama Pemain:</label>
  <input type="text" id="playerName" placeholder="Masukkan nama kamu" />

  <button id="joinBtn">Gabung Game</button>

  <div id="message"></div>
  <div id="role-display"></div>

  <script>
    // Ganti dengan config Firebase kamu
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const gameCodeInput = document.getElementById('gameCode');
    const playerNameInput = document.getElementById('playerName');
    const joinBtn = document.getElementById('joinBtn');
    const roleDisplay = document.getElementById('role-display');
    const messageDiv = document.getElementById('message');

    joinBtn.onclick = async () => {
      messageDiv.textContent = '';
      roleDisplay.textContent = '';

      const gameCode = gameCodeInput.value.trim().toUpperCase();
      const playerName = playerNameInput.value.trim();

      if (!gameCode || !playerName) {
        messageDiv.textContent = 'Kode putaran dan nama pemain wajib diisi.';
        return;
      }

      try {
        // Cek game tersedia
        const gameDoc = await db.collection('games').doc(gameCode).get();
        if (!gameDoc.exists) {
          messageDiv.textContent = 'Kode putaran tidak ditemukan.';
          return;
        }
        const gameData = gameDoc.data();

        // Cek apakah pemain sudah terdaftar di game ini
        const playerRef = db.collection('games').doc(gameCode).collection('players').doc(playerName);
        const playerDoc = await playerRef.get();

        if (playerDoc.exists) {
          // Kalau sudah ada, tampilkan peran
          roleDisplay.textContent = `Halo ${playerName}, peran kamu adalah: ${playerDoc.data().role}`;
          return;
        }

        // Kalau belum ada, generate peran dari sisa peran yang belum dipakai
        const playersSnapshot = await db.collection('games').doc(gameCode).collection('players').get();
        const assignedRoles = playersSnapshot.docs.map(doc => doc.data().role);
        const availableRoles = [...gameData.roles]; // roles disimpan array per putaran

        // Hitung sisa peran yang belum dipakai
        let roleCount = {};
        availableRoles.forEach(r => roleCount[r] = (roleCount[r] || 0) + 1);
        assignedRoles.forEach(r => roleCount[r] = roleCount[r] - 1);

        // Filter role yang masih ada jumlahnya > 0
        const remainingRoles = Object.entries(roleCount).filter(([r, c]) => c > 0).map(([r]) => r);
        if (remainingRoles.length === 0) {
          messageDiv.textContent = 'Maaf, peran untuk putaran ini sudah penuh.';
          return;
        }

        // Pilih peran random dari remainingRoles
        const randomRole = remainingRoles[Math.floor(Math.random() * remainingRoles.length)];

        // Simpan pemain dan peran ke firestore
        await playerRef.set({ role: randomRole });

        roleDisplay.textContent = `Halo ${playerName}, peran kamu adalah: ${randomRole}`;

      } catch (err) {
        console.error(err);
        messageDiv.textContent = 'Terjadi kesalahan, coba lagi.';
      }
    }
  </script>
</body>
</html>
