<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Werewolf Game - Login & Admin + Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f7f9;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      margin-bottom: 20px;
      color: #4b6cb7;
      text-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .btn-group {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
    }
    .btn-group button {
      flex: 1;
      padding: 12px 0;
      border: none;
      background: #4b6cb7;
      color: white;
      font-weight: 600;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: 0 3px 8px rgba(75,108,183,0.3);
    }
    .btn-group button:hover {
      background: #3956a4;
    }
    .section {
      width: 100%;
      max-width: 480px;
      background: white;
      padding: 25px 30px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(75,108,183,0.15);
      display: none;
      flex-direction: column;
    }
    .visible {
      display: flex;
    }
    label {
      font-weight: 600;
      margin-top: 15px;
      margin-bottom: 6px;
      color: #4b6cb7;
    }
    input[type="text"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1.8px solid #c1c9dd;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.3s ease;
      resize: vertical;
    }
    input[type="text"]:focus,
    input[type="password"]:focus,
    textarea:focus {
      outline: none;
      border-color: #4b6cb7;
      box-shadow: 0 0 6px #4b6cb7aa;
    }
    button[type="button"] {
      margin-top: 25px;
      padding: 12px;
      font-size: 16px;
      font-weight: 700;
      color: white;
      background: #4b6cb7;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(75,108,183,0.4);
      transition: background-color 0.3s ease;
    }
    button[type="button"]:hover {
      background: #3956a4;
    }
    #role-display {
      margin-top: 18px;
      font-weight: 700;
      font-size: 18px;
      color: #2f4858;
      background: #d1e7ff;
      padding: 12px 18px;
      border-radius: 8px;
      box-shadow: inset 0 0 8px #a6c1ff;
    }
    #registerMsg,
    #loginMsg {
      margin-top: 14px;
      font-weight: 600;
      min-height: 20px;
      color: #d9534f; /* default red */
    }
    #registerMsg.success,
    #loginMsg.success {
      color: #28a745; /* green */
    }
    #adminTools {
      margin-top: 25px;
      width: 100%;
    }
    #playerList {
      margin-top: 15px;
      max-height: 220px;
      overflow-y: auto;
      padding-left: 20px;
      border: 1px solid #c1c9dd;
      border-radius: 8px;
      background: #f9fbff;
    }
    #playerList li {
      margin-bottom: 8px;
      font-weight: 600;
      color: #2f4858;
      list-style: none;
      padding-left: 20px;
      position: relative;
      cursor: pointer;
      user-select: none;
    }
    #playerList li::before {
      content: "üê∫";
      position: absolute;
      left: 0;
      top: 2px;
    }
    /* CHAT STYLES */
    #chat-container {
      margin-top: 20px;
      border: 1.5px solid #4b6cb7;
      border-radius: 10px;
      height: 300px;
      display: flex;
      flex-direction: column;
      background: #e6f0ff;
    }
    #chat-messages {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      font-size: 14px;
      color: #2f4858;
    }
    #chat-input-container {
      display: flex;
      border-top: 1.5px solid #4b6cb7;
    }
    #chat-input {
      flex-grow: 1;
      border: none;
      padding: 12px;
      font-size: 14px;
      border-radius: 0 0 0 10px;
      outline: none;
    }
    #chat-send-btn {
      background: #4b6cb7;
      border: none;
      color: white;
      font-weight: 600;
      font-size: 16px;
      padding: 0 20px;
      cursor: pointer;
      border-radius: 0 0 10px 0;
      transition: background-color 0.3s ease;
    }
    #chat-send-btn:hover {
      background: #3956a4;
    }
    /* Admin chat panel */
    #adminChatPanel {
      margin-top: 25px;
      border: 1.5px solid #4b6cb7;
      border-radius: 10px;
      background: #f0f6ff;
      padding: 15px;
    }
    #chatPlayerList {
      max-height: 140px;
      overflow-y: auto;
      border: 1px solid #c1c9dd;
      border-radius: 8px;
      padding-left: 10px;
      background: white;
      margin-bottom: 15px;
    }
    #chatPlayerList li {
      padding: 6px 10px;
      cursor: pointer;
      list-style: none;
      border-bottom: 1px solid #c1c9dd;
      font-weight: 600;
      color: #4b6cb7;
      user-select: none;
    }
    #chatPlayerList li.active {
      background: #4b6cb7;
      color: white;
    }
    #adminChatMessages {
      height: 220px;
      overflow-y: auto;
      border: 1px solid #c1c9dd;
      border-radius: 8px;
      background: white;
      padding: 10px;
      font-size: 14px;
      color: #2f4858;
      margin-bottom: 10px;
    }
    #adminChatInputContainer {
      display: flex;
    }
    #adminChatInput {
      flex-grow: 1;
      padding: 8px 12px;
      font-size: 14px;
      border: 1.5px solid #4b6cb7;
      border-radius: 6px 0 0 6px;
      outline: none;
    }
    #adminChatSendBtn {
      background: #4b6cb7;
      border: none;
      color: white;
      font-weight: 600;
      font-size: 16px;
      padding: 0 18px;
      cursor: pointer;
      border-radius: 0 6px 6px 0;
      transition: background-color 0.3s ease;
    }
    #adminChatSendBtn:hover {
      background: #3956a4;
    }
    @media (max-width: 520px) {
      .btn-group {
        flex-direction: column;
      }
      .btn-group button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>Werewolf Game</h1>

  <div class="btn-group" role="group" aria-label="Navigation Buttons">
    <button type="button" onclick="showSection('register')">Daftar Disini</button>
    <button type="button" onclick="showSection('login')">Login Pemain</button>
    <button type="button" onclick="showSection('admin')">Akses Tuhan</button>
  </div>

  <!-- Daftar Pemain -->
  <section id="register-section" class="section" aria-labelledby="register-title" role="region">
    <h2 id="register-title">Daftar Pemain Baru</h2>
    <label for="regName">Nama Pemain</label>
    <input type="text" id="regName" name="regName" placeholder="Nama kamu" autocomplete="off" aria-required="true" />
    <label for="regPassword">Password</label>
    <input type="password" id="regPassword" name="regPassword" placeholder="Password" autocomplete="off" aria-required="true" />
    <button type="button" onclick="registerPlayer()">Daftar</button>
    <div id="registerMsg" role="alert" aria-live="polite"></div>
  </section>

  <!-- Login Pemain -->
  <section id="login-section" class="section" aria-labelledby="login-title" role="region">
    <h2 id="login-title">Login Pemain</h2>
    <label for="loginName">Nama Pemain</label>
    <input type="text" id="loginName" name="loginName" placeholder="Nama kamu" autocomplete="off" aria-required="true" />
    <label for="loginPassword">Password</label>
    <input type="password" id="loginPassword" name="loginPassword" placeholder="Password" autocomplete="off" aria-required="true" />
    <label for="loginGameCode">Kode Putaran</label>
    <input type="text" id="loginGameCode" name="loginGameCode" placeholder="Contoh: PUTARAN1" autocomplete="off" aria-required="true" />
    <button type="button" onclick="loginPlayer()">Login</button>
    <div id="loginMsg" role="alert" aria-live="polite"></div>

    <!-- Info Role dan chat muncul setelah login -->
    <div id="playerInfo" style="margin-top: 20px; display:none;">
      <div id="role-display" aria-live="polite"></div>
      
      <!-- Chat container -->
      <div id="chat-container" aria-label="Chat Pemain" role="region" aria-live="polite">
        <div id="chat-messages" tabindex="0" aria-label="Pesan chat"></div>
        <div id="chat-input-container">
          <input type="text" id="chat-input" aria-label="Ketik pesan chat" placeholder="Ketik pesan dan tekan kirim..." />
          <button type="button" id="chat-send-btn" aria-label="Kirim pesan chat">Kirim</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin Tuhan -->
  <section id="admin-section" class="section" aria-labelledby="admin-title" role="region">
    <h2 id="admin-title">Panel Admin (Tuhan)</h2>
    <label for="adminPassword">Masukkan Password Admin</label>
    <input type="password" id="adminPassword" placeholder="Password Admin" autocomplete="off" aria-required="true" />
    <button type="button" onclick="loginAdmin()">Login Admin</button>
    <div id="adminMsg" role="alert" aria-live="polite" style="margin-top: 12px; font-weight: 600; color: #d9534f;"></div>

    <!-- Admin tools -->
    <div id="adminTools" style="display:none;">
      <h3>Daftar Pemain Login</h3>
      <ul id="playerList" tabindex="0" aria-label="Daftar Pemain"></ul>

      <h3>Chat dengan Pemain</h3>
      <ul id="chatPlayerList" tabindex="0" aria-label="Daftar Pemain untuk Chat"></ul>
      <div id="adminChatPanel" style="display:none;">
        <div id="adminChatMessages" tabindex="0" aria-label="Pesan chat dengan pemain"></div>
        <div id="adminChatInputContainer">
          <input type="text" id="adminChatInput" aria-label="Ketik balasan chat" placeholder="Tulis balasan..." />
          <button type="button" id="adminChatSendBtn">Kirim</button>
        </div>
      </div>
    </div>
  </section>

  <script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD5rn8JWl9WjmKkEgnX7XzZwHGW3x2VQqQ",
  authDomain: "warewolf-game-ef2fd.firebaseapp.com",
  projectId: "warewolf-game-ef2fd",
  storageBucket: "warewolf-game-ef2fd.firebasestorage.app",
  messagingSenderId: "342790419722",
  appId: "1:342790419722:web:e51e9b9c1c54286729f6f3",
  measurementId: "G-6VE9WCE2E2"
};

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global state
    let currentPlayer = null; // {name, password, gameCode, role}
    let currentAdmin = false;
    let chatUnsubscribe = null;
    let adminChatUnsubscribe = null;
    let selectedChatPlayer = null;

    // Show section
    function showSection(section) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('visible'));
      if (section === 'register') {
        document.getElementById('register-section').classList.add('visible');
      } else if (section === 'login') {
        document.getElementById('login-section').classList.add('visible');
      } else if (section === 'admin') {
        document.getElementById('admin-section').classList.add('visible');
      }
    }
    showSection('register');

    // Register player
    async function registerPlayer() {
      const name = document.getElementById('regName').value.trim();
      const password = document.getElementById('regPassword').value.trim();
      const msg = document.getElementById('registerMsg');

      msg.textContent = "";
      if (!name || !password) {
        msg.textContent = "Nama dan password wajib diisi.";
        return;
      }

      try {
        const playerDoc = await db.collection('players').doc(name).get();
        if (playerDoc.exists) {
          msg.textContent = "Nama pemain sudah terdaftar. Pilih nama lain.";
          return;
        }
        await db.collection('players').doc(name).set({
          password,
          role: "",
          gameCode: "",
          registeredAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        msg.textContent = "Registrasi berhasil! Silakan login.";
        msg.classList.add('success');
        // Reset input
        document.getElementById('regName').value = "";
        document.getElementById('regPassword').value = "";
      } catch (error) {
        msg.textContent = "Terjadi kesalahan saat registrasi.";
        console.error(error);
      }
    }

    // Login player
    async function loginPlayer() {
      const name = document.getElementById('loginName').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      const gameCode = document.getElementById('loginGameCode').value.trim().toUpperCase();
      const msg = document.getElementById('loginMsg');

      msg.textContent = "";
      if (!name || !password || !gameCode) {
        msg.textContent = "Semua kolom wajib diisi.";
        return;
      }

      try {
        const playerDocRef = db.collection('players').doc(name);
        const playerDoc = await playerDocRef.get();
        if (!playerDoc.exists) {
          msg.textContent = "Nama pemain tidak ditemukan.";
          return;
        }
        const data = playerDoc.data();
        if (data.password !== password) {
          msg.textContent = "Password salah.";
          return;
        }

        // Update gameCode & role for this round (simplified: just set gameCode here)
        await playerDocRef.update({ gameCode });

        // Ambil role dari game state (kalau sudah ada)
        let role = data.role || "(Belum dapat peran)";

        // Simpan global state player
        currentPlayer = { name, password, gameCode, role };

        // Tampilkan info role dan chat UI
        document.getElementById('role-display').textContent = `Halo, ${name}. Peranmu: ${role}`;
        document.getElementById('playerInfo').style.display = "block";

        // Kosongkan chat pesan
        document.getElementById('chat-messages').innerHTML = "";

        // Mulai listen chat realtime dari moderator (balasan) dan kirim chat
        startPlayerChatListener();

        msg.textContent = "";
      } catch (error) {
        msg.textContent = "Terjadi kesalahan saat login.";
        console.error(error);
      }
    }

    // Login admin
    function loginAdmin() {
      const password = document.getElementById('adminPassword').value;
      const msg = document.getElementById('adminMsg');
      msg.textContent = "";

      // Password admin simpel - ganti sesuai kebutuhan
      const ADMIN_PASSWORD = "tuhan123";

      if (password === ADMIN_PASSWORD) {
        currentAdmin = true;
        msg.textContent = "Login admin berhasil.";
        msg.style.color = "#28a745";
        document.getElementById('adminTools').style.display = "block";

        // Load player list realtime
        loadPlayerListForAdmin();

      } else {
        currentAdmin = false;
        msg.textContent = "Password admin salah.";
        msg.style.color = "#d9534f";
        document.getElementById('adminTools').style.display = "none";
      }
    }

    // Load player list for admin with realtime update
    function loadPlayerListForAdmin() {
      db.collection('players')
        .orderBy('registeredAt', 'desc')
        .onSnapshot(snapshot => {
          const playerList = document.getElementById('playerList');
          const chatPlayerList = document.getElementById('chatPlayerList');
          playerList.innerHTML = "";
          chatPlayerList.innerHTML = "";
          snapshot.forEach(doc => {
            const p = doc.data();
            const name = doc.id;
            const li = document.createElement('li');
            li.textContent = `${name} (${p.gameCode || "-"}) Role: ${p.role || "(belum)"}`;
            playerList.appendChild(li);

            // Chat player list
            const liChat = document.createElement('li');
            liChat.textContent = name;
            liChat.setAttribute('tabindex', '0');
            liChat.onclick = () => selectChatPlayer(name);
            liChat.onkeypress = (e) => { if (e.key === 'Enter') selectChatPlayer(name); };
            chatPlayerList.appendChild(liChat);
          });
        });
    }

    // Select player for admin chat
    function selectChatPlayer(name) {
      selectedChatPlayer = name;

      // Highlight selected player in chatPlayerList
      const chatPlayerListItems = document.querySelectorAll('#chatPlayerList li');
      chatPlayerListItems.forEach(li => {
        if (li.textContent === name) {
          li.classList.add('active');
        } else {
          li.classList.remove('active');
        }
      });

      // Show admin chat panel
      const chatPanel = document.getElementById('adminChatPanel');
      chatPanel.style.display = "flex";

      // Clear chat messages
      const adminChatMessages = document.getElementById('adminChatMessages');
      adminChatMessages.innerHTML = "";

      // Unsubscribe previous listener if ada
      if (adminChatUnsubscribe) {
        adminChatUnsubscribe();
      }

      // Listen chat messages realtime for selected player
      adminChatUnsubscribe = db.collection('chats')
        .doc(`${selectedChatPlayer}`)
        .collection('messages')
        .orderBy('createdAt')
        .onSnapshot(snapshot => {
          adminChatMessages.innerHTML = "";
          snapshot.forEach(doc => {
            const msg = doc.data();
            const div = document.createElement('div');
            div.style.marginBottom = '8px';
            div.style.padding = '6px 10px';
            div.style.borderRadius = '6px';
            if (msg.from === 'player') {
              div.style.background = '#d1e7ff';
              div.style.textAlign = 'left';
              div.textContent = `${selectedChatPlayer}: ${msg.text}`;
            } else if (msg.from === 'admin') {
              div.style.background = '#4b6cb7';
              div.style.color = 'white';
              div.style.textAlign = 'right';
              div.textContent = `Tuhan: ${msg.text}`;
            }
            adminChatMessages.appendChild(div);
          });
          adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
        });
    }

    // Kirim pesan chat oleh admin
    document.getElementById('adminChatSendBtn').addEventListener('click', async () => {
      if (!selectedChatPlayer) return;
      const input = document.getElementById('adminChatInput');
      const text = input.value.trim();
      if (!text) return;

      try {
        await db.collection('chats')
          .doc(selectedChatPlayer)
          .collection('messages')
          .add({
            text,
            from: 'admin',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        input.value = "";
      } catch (error) {
        alert("Gagal mengirim pesan admin.");
        console.error(error);
      }
    });

    // Pemain listen chat balasan dari admin (moderator)
    function startPlayerChatListener() {
      // Unsubscribe previous listener kalau ada
      if (chatUnsubscribe) chatUnsubscribe();

      const chatMessages = document.getElementById('chat-messages');
      chatMessages.innerHTML = "";

      const chatDoc = db.collection('chats').doc(currentPlayer.name);

      // Listen chat realtime
      chatUnsubscribe = chatDoc.collection('messages')
        .orderBy('createdAt')
        .onSnapshot(snapshot => {
          chatMessages.innerHTML = "";
          snapshot.forEach(doc => {
            const msg = doc.data();
            const div = document.createElement('div');
            div.style.marginBottom = '8px';
            div.style.padding = '6px 10px';
            div.style.borderRadius = '6px';
            if (msg.from === 'player') {
              div.style.background = '#4b6cb7';
              div.style.color = 'white';
              div.style.textAlign = 'right';
              div.textContent = `Kamu: ${msg.text}`;
            } else if (msg.from === 'admin') {
              div.style.background = '#d1e7ff';
              div.style.textAlign = 'left';
              div.textContent = `Tuhan: ${msg.text}`;
            }
            chatMessages.appendChild(div);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });

      // Kirim chat message
      const sendBtn = document.getElementById('chat-send-btn');
      const input = document.getElementById('chat-input');

      sendBtn.onclick = async () => {
        const text = input.value.trim();
        if (!text) return;
        try {
          await chatDoc.collection('messages').add({
            text,
            from: 'player',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          input.value = "";
        } catch (error) {
          alert("Gagal mengirim pesan chat.");
          console.error(error);
        }
      };

      // Kirim dengan enter di input
      input.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendBtn.click();
        }
      };
    }

  </script>
</body>
</html>
